<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <title>Vite App</title>
</head>

<body>
  <div id="app"></div>
  <div>
    <h1>Real Time BTC/USD Price</h1>
    <p id="price"></p>
    <div>
      <h2>Price History</h2>
      <div class="chart-container" style="position: relative; height:50vh; width:80vw">
        <canvas id="myChart"></canvas>
      </div>

    </div>
  </div>
  <!-- script for getting real time BTC/USD price -->
  <script>
    const values = [];
    const socket = new WebSocket('wss://ws-feed.pro.coinbase.com');
    socket.addEventListener('open', function (event) {
      socket.send(JSON.stringify({
        "type": "subscribe",
        "channels": [{ "name": "ticker", "product_ids": ["BTC-USD"] }]
      }));
    });
    socket.addEventListener('message', function (event) {
      const data = JSON.parse(event.data);
      if (data.type === 'ticker') {
        // add 
        values.push({
          x: `${new Date().getHours()}:${new Date().getMinutes()}:${new Date().getSeconds()}`
          , y: data.price
        });


        function renderChart() {
          const ctx = document.getElementById('myChart').getContext('2d');
          // destroy previous chart
          let existingChart = Chart.getChart('myChart');
          if (existingChart) {
            existingChart.destroy();
          }
          const myChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: values.map(v => v.x),
              datasets: [{
                label: 'BTC/USD',
                data: values.map(v => v.y),
                backgroundColor: [
                  'rgba(255, 99, 132, 0.2)'
                ],
                borderColor: [
                  'rgba(255, 99, 132, 1)'
                ],
                borderWidth: 1
              }]
            },
            options: {
              animation: false,
              responsive: true,
              maintainAspectRatio: true,
              elements: {
                line: {
                  tension: 0 // disables bezier curves
                },
                point: {
                  radius: 0 // hide points
                }
              }
            }
          });
          // disable animation on render
          myChart.options.animation = false;
          // sleep for 5 seconds
          setTimeout(() => {
            // remove first element from array
            values.shift();
            // render chart again
            renderChart();
          }, 200000);
        }
        // render canvas chart
        renderChart();

      }
    });
    // resize canvas so it fits the screen
    const canvas = document.getElementById('myChart');
  </script>
</body>

</html>