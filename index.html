<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- import test json -->
  <title>Vite App</title>
</head>

<body>
  <div id="app"></div>
  <div>
    <h1>Real Time BTC/USD Price</h1>
    <p id="price"></p>
    <div>
      <h2>Price History</h2>
      <div class="chart-container" style="position: relative; height:80vh; width:80vw">
        <canvas id="myChart" width="500" height="500" style="border:1px solid"></canvas>
      </div>
    </div>
  </div>
  <!-- script for getting candlestick data for BTC/USD 30m time frame -->
  <script>
    const canvas = document.getElementById('myChart');
    // const socket = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@kline_30m');
    // load test.json data
    const candleStickData = [];
    fetch('test.json')
      .then(response => response.json())
      .then(data => {
        console.log(data);
        for (let i = 0; i < data.length; i++) {
          const candle = data[i];
          candleStickData.push({
            t: candle.t,
            o: candle.o,
            h: parseFloat(candle.h),
            l: parseFloat(candle.l),
            c: candle.c
          });
        }
        normalizeData(candleStickData);
        renderChart(candleStickData);
      });
    console.log(candleStickData);
    // socket.onmessage = function (event) {
    //   const message = JSON.parse(event.data);
    //   const candle = message.k;
    //   const price = candle.c;
    //   candleStickData.push({
    //     t: candle.t,
    //     o: candle.o,
    //     h: candle.h,
    //     l: candle.l,
    //     c: candle.c
    //   });
    //   console.log(candleStickData);
    //   // normalizeData(candleStickData);
    //   // renderChart(candleStickData);
    // }
    function render() {
      ctx.drawImage(canvas, 0, 0);
      requestAnimationFrame(render);
    }
    render();

    function normalizeData(candleStickData) {
      // normalize data so it doesn't go out of the canvas
      let min = candleStickData[0].l;
      let max = candleStickData[0].h;
      for (let i = 0; i < candleStickData.length; i++) {
        if (candleStickData[i].l < min) {
          min = candleStickData[i].l;
        }
        if (candleStickData[i].h > max) {
          max = candleStickData[i].h;
        }
      }
      for (let i = 0; i < candleStickData.length; i++) {
        candleStickData[i].l = candleStickData[i].l - min;
        candleStickData[i].h = candleStickData[i].h - min;
      }
    }
    function renderChart(candleStickData) {
      let startY = 0;
      let startX = 0;
      let prev = 0;
      // move to center of canvas vertically and horizontally
      const ctx = canvas.getContext('2d');
      ctx.translate(0, canvas.height / 2);
      for (let i = 0; i < candleStickData.length; i++) {
        let diff = candleStickData[i].o - candleStickData[i].c;
        let height = parseInt(diff * 2);
        let width = 10;
        ctx.beginPath();
        ctx.fillStyle = height > prev ? 'green' : 'red';
        console.log(startX, startY, width, height);
        ctx.fillRect(startX, startY, width, height);
        ctx.fill();
        ctx.stroke();
        ctx.closePath();
        startY = height;
        prev = height;
        startX += canvas.width / candleStickData.length;
      }
    }
  </script>
</body>

</html>