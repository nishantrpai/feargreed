<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <title>Vite App</title>
</head>

<body>
  <div id="app"></div>
  <div>
    <h1>Real Time BTC/USD Price</h1>
    <p id="price"></p>
    <div>
      <h2>Price History</h2>
      <div class="chart-container" style="position: relative; height:80vh; width:80vw">
        <canvas id="myChart"></canvas>
      </div>
    </div>
  </div>
  <!-- script for getting real time BTC/USD price -->
  <script>
    const values = [];
    const socket = new WebSocket('wss://ws-feed.pro.coinbase.com');
    const canvas = document.getElementById('myChart');
    const ctx = canvas.getContext('2d');
    function getDate() {
      const date = new Date();
      return `${date.getHours() > 10 ? date.getHours() : '0' + date.getHours()}:${date.getMinutes() > 10 ? date.getMinutes() : '0' + date.getMinutes()}:${date.getSeconds() > 10 ? date.getSeconds() : '0' + date.getSeconds()}`;
    }
    socket.addEventListener('open', function (event) {
      socket.send(JSON.stringify({
        "type": "subscribe",
        "channels": [{ "name": "ticker", "product_ids": ["BTC-USD"] }]
      }));
    });
    socket.addEventListener('message', function (event) {
      const data = JSON.parse(event.data);
      if (data.type === 'ticker') {
        let price = parseFloat(data.price);
        const high24h = parseFloat(data.high_24h);
        const low24h = parseFloat(data.low_24h);
        const candleHeight = price - low24h;
        if (!isNaN(price)) {
          values.push({
            x: getDate(),
            y: price - low24h,
            price,
            height: candleHeight,
            normalized: false
          });
          normalizeValues();
          renderChart();
        }
      }
    });

    function normalizeValues() {
      let max = Math.max(...values.map(value => !value.normalized ? value.y : 0));
      let min = Math.min(...values.map(value => !value.normalized ? value.y : 0));
      values.forEach((value, index) => {
        if (index > 0 && !value.normalized) {
          value.y = (value.y - min) / (max - min);
          value.normalized = true;
        }
      });
    }

    function renderChart() {
      const labels = values.map(value => value.x);
      const data = values.map(value => value.y);
      const price = values.map(value => value.price);
      const height = values.map(value => value.height);
      let diff = 0;
      // normalize height so that it fits in the canvas
      const max = Math.max(...height);
      const min = Math.min(...height);
      height.forEach((value, index) => {
        height[index] = (value - min) / (max - min) * 0.8;
      });
      
      canvas.height = 1000;
      canvas.width = 1000;
      for (let i = 0; i < labels.length; i++) {
        if (i > 1) {
          ctx.beginPath();
          // move to the diff of the previous candlestick bar
          ctx.moveTo(i * 10, 1000 - diff * 1000);
          // render candlestick next to the previous one
          ctx.rect(i * 10, 200 - height[i] * 200, 5, data[i] * 200);
          ctx.fillStyle = height[i] > height[i - 1] ? 'green' : 'red';
          ctx.fill();
          ctx.stroke();
        } else {
          diff = data[1] - data[0];
        }
      }
    }

  </script>
</body>

</html>